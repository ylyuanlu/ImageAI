generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String        @id @default(uuid())
  email                    String        @unique
  username                 String        @unique
  password                 String
  avatar                   String?
  role                     String        @default("USER")
  status                   String        @default("ACTIVE")
  emailVerified            Boolean       @default(false)
  emailVerificationToken   String?
  emailVerificationExpires DateTime?
  passwordResetToken       String?
  passwordResetExpires     DateTime?
  createdAt                DateTime      @default(now())
  updatedAt                DateTime      @updatedAt
  lastLoginAt              DateTime?
  customPoses              CustomPose[]
  generations              Generation[]
  orders                   Order[]
  quota                    Quota?
  subscription             Subscription?
}

model Subscription {
  id                   String   @id @default(uuid())
  userId               String   @unique
  plan                 String   @default("FREE")
  status               String   @default("ACTIVE")
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  stripeCustomerId     String?
  stripeSubscriptionId String?
  cancelAtPeriodEnd    Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Quota {
  id             String    @id @default(uuid())
  userId         String    @unique
  freeQuota      Int       @default(5)
  freeQuotaUsed  Int       @default(0)
  paidQuota      Int       @default(0)
  paidQuotaUsed  Int       @default(0)
  extraQuota     Int       @default(0)
  extraQuotaUsed Int       @default(0)
  totalQuota     Int       @default(5)
  remainingQuota Int       @default(5)
  resetAt        DateTime?
  updatedAt      DateTime  @updatedAt
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Generation {
  id              String      @id @default(uuid())
  userId          String
  modelImage      String
  outfitImages    String
  pose            String
  style           String
  lighting        String
  background      String
  colorTone       String
  count           Int         @default(1)
  customPoseId    String?
  generatedImages String
  status          String      @default("PENDING")
  error           String?
  prompt          String?
  metadata        String?
  time            String?
  createdAt       DateTime    @default(now())
  completedAt     DateTime?
  customPose      CustomPose? @relation("CustomPoseGenerations", fields: [customPoseId], references: [id])
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([customPoseId])
}

model Pose {
  id          String   @id @default(uuid())
  name        String   @unique
  nameEn      String?
  category    String
  description String?
  previewUrl  String?
  prompt      String
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model CustomPose {
  id           String       @id @default(uuid())
  userId       String
  name         String
  description  String
  imageUrl     String
  thumbnailUrl String?
  category     String       @default("CUSTOM")
  tags         String?
  prompt       String?
  source       String       @default("TEXT")
  isFavorite   Boolean      @default(false)
  useCount     Int          @default(0)
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  generations  Generation[] @relation("CustomPoseGenerations")

  @@index([userId])
  @@index([createdAt])
}

model Outfit {
  id           String   @id @default(uuid())
  name         String   @unique
  category     String
  season       String
  style        String
  imageUrl     String
  thumbnailUrl String?
  description  String?
  tags         String
  popularity   Int      @default(0)
  rating       Float    @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model MembershipLevel {
  id            String   @id @default(uuid())
  level         String   @unique
  name          String
  price         Float
  yearlyPrice   Float
  monthlyQuota  Int
  maxResolution String
  priority      Int      @default(0)
  commercialUse Boolean  @default(false)
  watermark     Boolean  @default(true)
  features      String
  sortOrder     Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  orders        Order[]
}

model Order {
  id           String           @id @default(uuid())
  orderNo      String           @unique
  userId       String
  type         String
  membershipId String?
  quotaAmount  Int?
  amount       Float
  currency     String           @default("CNY")
  duration     Int?
  payMethod    String?
  payStatus    String           @default("PENDING")
  payTime      DateTime?
  payTradeNo   String?
  status       String           @default("PENDING")
  expireAt     DateTime
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  membership   MembershipLevel? @relation(fields: [membershipId], references: [id])
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments     Payment[]
}

model Payment {
  id         String    @id @default(uuid())
  orderId    String
  userId     String
  amount     Float
  currency   String    @default("CNY")
  payMethod  String
  payTradeNo String?
  status     String    @default("PENDING")
  payData    String?
  notifyData String?
  createdAt  DateTime  @default(now())
  paidAt     DateTime?
  order      Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([userId])
}

model Config {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt
}
