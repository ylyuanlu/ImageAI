// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// ğŸ“ è¯´æ˜ï¼šå½“å‰ä½¿ç”¨ SQLite è¿›è¡Œå¼€å‘
// ç”Ÿäº§ç¯å¢ƒè¯·åˆ‡æ¢å› PostgreSQLï¼š
// datasource db {
//   provider = "postgresql"
//   url      = env("DATABASE_URL")
// }

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ç”¨æˆ·è¡¨
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  username  String   @unique
  password  String   // åŠ å¯†å­˜å‚¨
  avatar    String?  // å¤´åƒURL
  role      String   @default("USER") // USER, ADMIN, VIP
  status    String   @default("ACTIVE") // ACTIVE, INACTIVE, SUSPENDED

  // é‚®ç®±éªŒè¯
  emailVerified Boolean @default(false)
  emailVerificationToken String?
  emailVerificationExpires DateTime?

  // å¯†ç é‡ç½®
  passwordResetToken String?
  passwordResetExpires DateTime?

  // ä¼šå‘˜ä¿¡æ¯
  subscription Subscription?

  // ç”Ÿæˆé¢åº¦
  quota       Quota?

  // å…³è”è®°å½•
  generations Generation[]
  orders      Order[]
  customPoses CustomPose[]

  // æ—¶é—´æˆ³
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastLoginAt DateTime?
}

// è®¢é˜…ä¿¡æ¯è¡¨
model Subscription {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  plan      String   @default("FREE") // FREE, MONTHLY, QUARTERLY, YEARLY
  status    String   @default("ACTIVE") // ACTIVE, CANCELED, PAST_DUE, UNPAID

  // è®¢é˜…å‘¨æœŸ
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime

  // æ”¯ä»˜ä¿¡æ¯
  stripeCustomerId   String?
  stripeSubscriptionId String?

  // å–æ¶ˆè®¢é˜…
  cancelAtPeriodEnd Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ç”¨æˆ·ç”Ÿæˆé¢åº¦è¡¨
model Quota {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // å…è´¹è¯•ç”¨é¢åº¦
  freeQuota       Int      @default(5)
  freeQuotaUsed   Int      @default(0)

  // ä»˜è´¹é¢åº¦ï¼ˆè®¢é˜…æœŸå†…ï¼‰
  paidQuota       Int      @default(0)
  paidQuotaUsed   Int      @default(0)

  // é¢å¤–è´­ä¹°é¢åº¦
  extraQuota      Int      @default(0)
  extraQuotaUsed  Int      @default(0)

  // æ€»é¢åº¦è®¡ç®—
  totalQuota      Int      @default(5)
  remainingQuota  Int      @default(5)

  // é¢åº¦é‡ç½®æ—¶é—´
  resetAt         DateTime?

  updatedAt       DateTime @updatedAt
}

// ç”Ÿæˆè®°å½•è¡¨
model Generation {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // è¾“å…¥å›¾ç‰‡ (JSON å­—ç¬¦ä¸²å­˜å‚¨æ•°ç»„)
  modelImage      String   // æ¨¡ç‰¹å‚è€ƒå›¾URL
  outfitImages    String   // æœè£…æ­é…å›¾URLsï¼ŒJSON æ•°ç»„å­—ç¬¦ä¸²

  // ç”Ÿæˆå‚æ•°
  pose        String
  style       String
  lighting    String
  background  String
  colorTone   String
  count       Int      @default(1)

  // å…³è”çš„è‡ªå®šä¹‰å§¿åŠ¿ï¼ˆå¯é€‰ï¼‰
  customPoseId String?
  customPose   CustomPose? @relation("CustomPoseGenerations", fields: [customPoseId], references: [id])

  // ç”Ÿæˆç»“æœ (JSON å­—ç¬¦ä¸²å­˜å‚¨æ•°ç»„)
  generatedImages String   // ç”Ÿæˆçš„å›¾ç‰‡URLsï¼ŒJSON æ•°ç»„å­—ç¬¦ä¸²

  // çŠ¶æ€
  status      String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  error       String?    // é”™è¯¯ä¿¡æ¯

  // å…ƒæ•°æ®
  prompt      String?    // ä½¿ç”¨çš„æç¤ºè¯
  metadata    String?    // é¢å¤–å…ƒæ•°æ®ï¼ŒJSON å­—ç¬¦ä¸²
  time        String?    // ç”Ÿæˆè€—æ—¶ï¼ˆç§’ï¼‰

  // æ—¶é—´æˆ³
  createdAt   DateTime   @default(now())
  completedAt DateTime?

  @@index([customPoseId])
}

// å§¿åŠ¿åº“è¡¨
model Pose {
  id          String   @id @default(uuid())
  name        String   @unique // å§¿åŠ¿åç§°
  nameEn      String?  // è‹±æ–‡åç§°
  category    String   // STANDING, SITTING, WALKING, CASUAL, PROFESSIONAL
  description String?  // æè¿°
  previewUrl  String?  // é¢„è§ˆå›¾URL
  prompt      String   // AIæç¤ºè¯

  // æ’åºå’ŒçŠ¶æ€
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ç”¨æˆ·è‡ªå®šä¹‰å§¿åŠ¿è¡¨
model CustomPose {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // å§¿åŠ¿ä¿¡æ¯
  name        String   // å§¿åŠ¿åç§°ï¼ˆç”¨æˆ·æè¿°çš„å‰20å­—ï¼‰
  description String   // å®Œæ•´æè¿°
  imageUrl    String   // ç”Ÿæˆçš„å‚è€ƒå›¾URL
  thumbnailUrl String? // ç¼©ç•¥å›¾URL

  // åˆ†ç±»å’Œæ ‡ç­¾
  category    String   @default("CUSTOM") // CUSTOM, PRESET
  tags        String?  // JSONæ•°ç»„å­—ç¬¦ä¸²

  // å…ƒæ•°æ®
  prompt      String?  // ä½¿ç”¨çš„AIæç¤ºè¯
  source      String   @default("TEXT") // TEXT-æ–‡æœ¬æè¿°, PRESET-åŸºäºé¢„è®¾ä¿®æ”¹

  // ç”¨æˆ·äº¤äº’
  isFavorite  Boolean  @default(false)
  useCount    Int      @default(0) // ä½¿ç”¨æ¬¡æ•°

  // çŠ¶æ€
  isActive    Boolean  @default(true)

  // å…³è”çš„ç”Ÿæˆè®°å½•
  generations Generation[] @relation("CustomPoseGenerations")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
}

// ç©¿æ­æ¨¡æ¿åº“è¡¨
model Outfit {
  id          String   @id @default(uuid())
  name        String   @unique // ç©¿æ­åç§°
  category    String   // SUMMER, WINTER, SPORT, FORMAL, CASUAL, PARTY
  season      String   // SPRING, SUMMER, AUTUMN, WINTER, ALL_YEAR
  style       String   // é£æ ¼æ ‡ç­¾

  // å›¾ç‰‡
  imageUrl    String   // ç©¿æ­å›¾URL
  thumbnailUrl String? // ç¼©ç•¥å›¾URL

  // æè¿°å’Œæ ‡ç­¾ (JSON å­—ç¬¦ä¸²å­˜å‚¨æ•°ç»„)
  description String?
  tags        String   // æ ‡ç­¾æ•°ç»„ï¼ŒJSON å­—ç¬¦ä¸²

  // æ¨èåº¦
  popularity  Int      @default(0)
  rating      Float    @default(0)

  // çŠ¶æ€
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ä¼šå‘˜ç­‰çº§é…ç½®è¡¨
model MembershipLevel {
  id          String   @id @default(uuid())
  level       String   @unique // BRONZE, SILVER, GOLD, PLATINUM, DIAMOND
  name        String   // æ˜¾ç¤ºåç§°
  price       Float    // æœˆè´¹ä»·æ ¼
  yearlyPrice Float    // å¹´è´¹ä»·æ ¼
  
  // æƒç›Šé…ç½®
  monthlyQuota    Int     // æ¯æœˆç”Ÿæˆé¢åº¦
  maxResolution   String  // æœ€å¤§åˆ†è¾¨ç‡ 1024x1024, 2048x2048
  priority        Int     @default(0) // ç”Ÿæˆä¼˜å…ˆçº§
  commercialUse   Boolean @default(false) // å•†ä¸šä½¿ç”¨æƒé™
  watermark       Boolean @default(true) // æ˜¯å¦å¸¦æ°´å°
  
  // å…¶ä»–æƒç›Š
  features        String  // æƒç›Šåˆ—è¡¨ï¼ŒJSON æ•°ç»„
  
  sortOrder       Int     @default(0)
  isActive        Boolean @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // å…³è”è®¢å•
  orders          Order[]
}

// è®¢å•è¡¨
model Order {
  id          String   @id @default(uuid())
  orderNo     String   @unique // è®¢å•å·
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // è®¢å•ç±»å‹
  type        String   // MEMBERSHIP-ä¼šå‘˜, QUOTA-é¢åº¦å……å€¼
  
  // å•†å“ä¿¡æ¯
  membershipId String?
  membership   MembershipLevel? @relation(fields: [membershipId], references: [id])
  quotaAmount  Int?     // å……å€¼é¢åº¦æ•°é‡
  
  // ä»·æ ¼ä¿¡æ¯
  amount      Float    // è®¢å•é‡‘é¢
  currency    String   @default("CNY")
  duration    Int?     // ä¼šå‘˜æ—¶é•¿ï¼ˆæœˆï¼‰
  
  // æ”¯ä»˜ä¿¡æ¯
  payMethod   String?  // ALIPAY, WECHAT
  payStatus   String   @default("PENDING") // PENDING, PAID, FAILED, CANCELED, REFUNDED
  payTime     DateTime?
  payTradeNo  String?  // ç¬¬ä¸‰æ–¹æ”¯ä»˜æµæ°´å·
  
  // è®¢å•çŠ¶æ€
  status      String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, CANCELED
  
  // è¿‡æœŸæ—¶é—´ï¼ˆç”¨äºæœªæ”¯ä»˜è®¢å•è‡ªåŠ¨å…³é—­ï¼‰
  expireAt    DateTime
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // å…³è”æ”¯ä»˜è®°å½•
  payments    Payment[]
}

// æ”¯ä»˜è®°å½•è¡¨
model Payment {
  id          String   @id @default(uuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  userId      String
  
  // æ”¯ä»˜ä¿¡æ¯
  amount      Float    // é‡‘é¢
  currency    String   @default("CNY")
  
  // ç¬¬ä¸‰æ–¹æ”¯ä»˜ä¿¡æ¯
  payMethod   String   // ALIPAY, WECHAT
  payTradeNo  String?  // ç¬¬ä¸‰æ–¹æµæ°´å·
  
  // æ”¯ä»˜çŠ¶æ€
  status      String   @default("PENDING") // PENDING, SUCCESS, FAILED, CANCELED
  
  // æ”¯ä»˜è¯¦æƒ…ï¼ˆJSONï¼‰
  payData     String?  // æ”¯ä»˜è¯·æ±‚æ•°æ®
  notifyData  String?  // æ”¯ä»˜å›è°ƒæ•°æ®
  
  // æ—¶é—´æˆ³
  createdAt   DateTime @default(now())
  paidAt      DateTime?
  
  @@index([orderId])
  @@index([userId])
}

// ç³»ç»Ÿé…ç½®è¡¨
model Config {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt
}
