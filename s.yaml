# 阿里云 Serverless 应用平台 (CAP) 部署配置
# 本文件用于阿里云 Serverless Devs CLI 部署
# 参考文档: https://www.aliyun.com/product/serverless-devs

edition: 3.0.0
name: imageai-app
access: default

vars:
  region: cn-hangzhou
  serviceName: imageai-service
  functionName: imageai-function

resources:
  imageai_service:
    component: fc3
    props:
      region: ${vars.region}
      serviceName: ${vars.serviceName}
      description: ImageAI Next.js 应用服务
      
  imageai_function:
    component: fc3
    props:
      region: ${vars.region}
      serviceName: ${vars.serviceName}
      functionName: ${vars.functionName}
      description: ImageAI Next.js 函数
      runtime: custom
      cpu: 1
      memorySize: 2048
      diskSize: 512
      timeout: 60
      instanceConcurrency: 100
      # 环境变量将在阿里云控制台配置，这里只定义结构
      environmentVariables:
        NODE_ENV: production
        # 数据库 - 使用现有的 Neon PostgreSQL
        DATABASE_URL: ${env.DATABASE_URL}
        # JWT 配置
        JWT_SECRET: ${env.JWT_SECRET}
        JWT_EXPIRES_IN: ${env.JWT_EXPIRES_IN}
        # AI API - 通义千问
        TONGYI_API_KEY: ${env.TONGYI_API_KEY}
        # 应用配置
        NEXT_PUBLIC_APP_URL: ${env.NEXT_PUBLIC_APP_URL}
        NEXT_PUBLIC_APP_NAME: ${env.NEXT_PUBLIC_APP_NAME}
        # 文件存储 - 阿里云 OSS（推荐）
        ALIYUN_ACCESS_KEY_ID: ${env.ALIYUN_ACCESS_KEY_ID}
        ALIYUN_ACCESS_KEY_SECRET: ${env.ALIYUN_ACCESS_KEY_SECRET}
        ALIYUN_OSS_REGION: ${env.ALIYUN_OSS_REGION}
        ALIYUN_OSS_BUCKET: ${env.ALIYUN_OSS_BUCKET}
        # 邮件服务
        RESEND_API_KEY: ${env.RESEND_API_KEY}
        FROM_EMAIL: ${env.FROM_EMAIL}
        FROM_NAME: ${env.FROM_NAME}
        # 功能开关
        ENABLE_REGISTRATION: ${env.ENABLE_REGISTRATION}
        ENABLE_PAYMENT: ${env.ENABLE_PAYMENT}
      customRuntimeConfig:
        command:
          - node
          - server.js
        port: 3000
      code: ./
      triggers:
        - triggerName: httpTrigger
          triggerType: http
          triggerConfig:
            authType: anonymous
            methods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
      customDomains:
        - domainName: auto
          protocol: HTTP
          routeConfigs:
            - path: /*
              serviceName: ${vars.serviceName}
              functionName: ${vars.functionName}
