# /security-scan - 安全扫描

## 描述

执行全面的安全审查，包括 SAST 静态代码分析、SCA 依赖漏洞扫描和配置安全检查。这是部署前的必经阶段，确保代码不存在高危安全漏洞。

## 前置条件

- ✅ 代码审查已通过（code-review-report.md 存在且通过）

## 工作流程

```
用户输入 /security-scan
  ↓
主控检测代码审查是否已通过
  ↓
调用 security-scanner
  ↓
执行 SAST 静态安全扫描
  ├─ 检测硬编码密钥和敏感信息
  ├─ 检测 SQL 注入漏洞
  ├─ 检测 XSS 跨站脚本漏洞
  ├─ 检测不安全的依赖项（SCA）
  └─ 检测不安全的配置
  ↓
生成安全扫描报告
  ↓
如果发现高危漏洞
  ├─ 列出漏洞详情和风险等级
  ├─ 提供修复建议
  └─ 阻止进入部署阶段
  ↓
流程结束
  ↓
个人开发者模式：仅扫描高危漏洞，中低危警告但不阻断
```

## 扫描维度

### 1. SAST - 静态代码分析

| 漏洞类型 | 检测内容 | 风险等级 |
|---------|---------|---------|
| **硬编码密钥** | API密钥、数据库密码、私钥等 | 🔴 高危 |
| **SQL注入** | 字符串拼接SQL、未参数化查询 | 🔴 高危 |
| **XSS漏洞** | 未转义的HTML输出、危险innerHTML | 🔴 高危 |
| **CSRF漏洞** | 缺失CSRF保护、不安全的请求 | 🟡 中危 |
| **路径遍历** | 未验证的文件路径、目录跳转 | 🟡 中危 |

### 2. SCA - 依赖漏洞扫描

| 检查项 | 说明 | 风险等级 |
|--------|------|---------|
| **已知CVE漏洞** | 依赖库中的已知安全漏洞 | 🔴 高危 |
| **过期依赖** | 长期未更新的依赖包 | 🟡 中危 |
| **许可证合规** | 检查许可证冲突 | 🟢 低危 |

### 3. 配置安全检查

| 检查项 | 说明 | 风险等级 |
|--------|------|---------|
| **环境变量** | 检查.env文件是否提交到Git | 🔴 高危 |
| **调试模式** | 生产环境是否开启调试 | 🔴 高危 |
| **CORS配置** | 过于宽松的跨域配置 | 🟡 中危 |
| **CSP头** | 是否配置Content-Security-Policy | 🟡 中危 |

## 输出文件

- **security-report.md**: 完整的安全扫描报告，包含：
  - 风险汇总（高危/中危/低危数量）
  - SAST扫描结果
  - SCA依赖漏洞详情
  - 配置检查结果
  - 修复建议和代码示例
  - 部署建议

## 个人开发者模式

针对独立开发者的简化策略：

```yaml
阻断条件: 仅高危漏洞阻断部署
中低危漏洞: 显示警告但不阻断
扫描范围: 核心安全漏洞（密钥、注入、XSS）
报告格式: 简化版，仅显示关键问题
```

## 示例

### 正常扫描

```
用户：/security-scan
AI：开始安全扫描...
    ✓ SAST扫描完成（耗时 45s）
    ✓ SCA扫描完成（发现 2 个中危漏洞）
    ✓ 配置检查完成
    
    扫描结果：
    🔴 高危漏洞：0
    🟡 中危漏洞：2
    🟢 低危提示：3
    
    ⚠️ 发现中危漏洞，建议修复后再部署
    查看详细报告：security-report.md
    
    是否继续部署？(Y/n): 
```

### 发现高危漏洞

```
用户：/security-scan
AI：开始安全扫描...
    ✓ SAST扫描完成
    ⚠️ 发现高危漏洞！
    
    🔴 高危漏洞：1
       - 硬编码API密钥 (src/config/api.ts:12)
    
    🔴 部署已阻断，必须修复高危漏洞
    查看详细报告：security-report.md
    
    修复建议：
    1. 将API密钥移到.env文件
    2. 重新执行 /security-scan
```

## 最佳实践

1. **定期扫描**: 每次代码变更后执行
2. **及时修复**: 
   - 高危漏洞：24小时内修复
   - 中危漏洞：1周内修复
   - 低危漏洞：1个月内修复
3. **依赖管理**: 每月运行 `npm audit` 或 `yarn audit`
4. **密钥管理**: 使用环境变量或密钥管理服务（如AWS Secrets Manager）

## 相关指令

- `/review` - 前置依赖
- `/deploy` - 后置依赖（需要安全扫描通过）

## 常见问题

**Q: 扫描会修改我的代码吗？**
A: 不会，扫描仅生成报告，不会自动修改代码。

**Q: 如何处理误报？**
A: 可以在配置文件中添加忽略规则，但需记录原因。

**Q: 扫描耗时多久？**
A: 取决于项目规模，一般1-5分钟。

**Q: 中危漏洞必须修复吗？**
A: 个人开发者模式下不强制，但建议修复。生产环境建议修复所有中高危漏洞。

## 推荐操作

**输入 `/security-scan` 执行安全扫描**

或继续下一步：
- 如果通过：`/deploy` 部署上线
- 如果失败：修复漏洞后重新执行 `/security-scan`
