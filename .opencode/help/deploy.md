# /deploy - 部署上线

## 描述

配置 CI/CD 流水线，执行部署到目标环境。

## 前置条件

- **代码审查通过**：code-review-report.md 存在且通过

## 参考学习

使用全局技能 `ci-cd` 学习 CI/CD 最佳实践

## 工作流程

```
用户输入 /deploy
  ↓
主控检测代码审查是否已通过
  ↓
检测项目类型和现有配置
  ↓
配置 CI/CD 流水线
  ↓
选择部署目标
  ↓
执行部署
  ↓
验证部署结果
```

## 部署目标

| 目标 | 特点 | 适用场景 |
|------|------|----------|
| Vercel | 自动部署、边缘加速 | Next.js、前端项目 |
| Netlify | 静态托管、自动构建 | 静态网站、前端 |
| 阿里云 ECS | 完全控制 | 后端服务 |
| Docker | 容器化部署 | 跨平台、可扩展 |

## CI/CD 流水线

### 标准流水线结构

```yaml
# 1. 快速反馈（lint、format）- <1 min
# 2. 单元测试 - 1-5 min
# 3. 集成测试 - 5-15 min
# 4. 构建产物
# 5. 部署（需审批）
```

### 关键原则

- **Fail Fast**：先运行快速验证
- **Parallelize**：并行化任务
- **Cache**：缓存依赖
- **Artifacts**：构建一次，部署多次

## 部署结果

| 结果 | 描述 | 后续操作 |
|------|------|----------|
| ✅ 成功 | 部署完成，服务正常 | 使用 /check 检查完整性 |
| ⚠️ 部分成功 | 部署完成，部分功能异常 | 检查日志，修复问题 |
| ❌ 失败 | 部署失败 | 检查配置，重试部署 |

## 相关指令

| 指令 | 描述 | 关系 |
|------|------|------|
| `/review` | 代码审查 | 前置步骤 |
| `/check` | 完整度检查 | 下一步 |

## 后续操作

部署成功后，建议：
1. 访问部署地址验证功能
2. 使用 `/check` 检查功能完整性
3. 配置监控和告警
4. **查阅 OPS-GUIDE.md 了解运维操作**

## OPS-GUIDE.md 运维指南

部署成功后会自动生成 `OPS-GUIDE.md` 文件，包含：

| 内容 | 说明 |
|------|------|
| **服务信息** | 服务名称、端口、启动命令 |
| **健康检查** | 检查命令、预期结果、失败处理 |
| **日志管理** | 日志配置、查看命令 |
| **监控配置** | 关键指标、告警阈值 |
| **回滚机制** | 回滚命令、验证流程 |

### 运维常用命令

```bash
# 健康检查
curl http://localhost:<端口>/health

# 查看日志
tail -f logs/app.log

# 重启服务
pm2 restart <服务名>

# 回滚版本
git checkout <上一版本>
npm run build
pm2 restart <服务名>
```

### 监控指标

| 指标 | 阈值 | 说明 |
|------|------|------|
| CPU | > 80% | 警告 |
| 内存 | > 80% | 警告 |
| 磁盘 | > 80% | 警告 |
| 响应时间 | > 2s | 警告 |

## 示例

**用户**："部署"

**AI**：
```
检测项目类型：Next.js
检测现有 CI/CD：无

正在配置 CI/CD 流水线...
✓ .github/workflows/deploy.yml 已生成

请选择部署目标：
1. Vercel（推荐）
2. 阿里云 ECS
3. Docker 容器
4. 本地测试（不实际部署）

请选择 [1/2/3/4]：

用户：1

正在部署到 Vercel...
✓ 构建成功
✓ 部署成功
   URL: https://imageai.vercel.app

正在验证部署...
✓ 健康检查通过
✓ 核心功能正常

部署结果：✅ 成功

建议：
- 使用 /check 检查功能完整性
- 配置自定义域名（可选）
```
